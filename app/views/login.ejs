<%- contentFor('title') %>
EspChat - Entrar

<%- contentFor('content') %>
<div class="jumbotron">
    <h1>Fazer Login</h1>
    <div class="form-group">
        <input id="name" type="text" class="form-control" placeholder="Nome de usuário">
    </div>
    <button id="join" class="btn btn-block btn-primary">Entrar</button>
    </form>
    <hr class="my-4">
    <h2>Usuários Online</h2>
    <p id="users"></p>
</div>

<%- contentFor('scripts') %>
<script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
<script>
    var socket = io("/lobby");
    var userList;
    socket.on("validate", function (users) {
        userList = users;
    });

    function post(path, params, method = 'post') {
        const form = document.createElement('form');
        form.method = method;
        form.action = path;
        for (const key in params) {
            if (params.hasOwnProperty(key)) {
                const hiddenField = document.createElement('input');
                hiddenField.type = 'hidden';
                hiddenField.name = key;
                hiddenField.value = params[key];
                form.appendChild(hiddenField);
            }
        }
        document.body.appendChild(form);
        form.submit();
    }
    function getUsers(users) {
        for(user of users) {
            $("#users").append(user+", ");
        }
    }

    $("#join").click(function (event) {
        if ($("#name").val().length) {
            event.preventDefault();
            var validate = false;
            for (user of userList) {
                if (user == $("#name").val()) {
                    validate = true;
                    break;
                }
            }
            if (validate) {
                $("#name").val("");
                toastr.error('Este usuário já está online!', 'Desculpe.');
            }
            else {
                post('/chat', { username: $("#name").val() });
            }
        }
        else {
            toastr.error('Você deve inserir um nome de usuário!', 'Fique atento!');
        }
    });
    $("#name").keypress(function (event) {
        if (event.which == 13) {
            if ($("#name").val().length) {
                event.preventDefault();
                var validate = false;
                for (user of userList) {
                    if (user == $("#name").val()) {
                        validate = true;
                        break;
                    }
                }
                if (validate) {
                    $("#name").val("");
                    toastr.error('Este usuário já está online!', 'Desculpe.');
                }
                else {
                    post('/chat', { username: $("#name").val() });
                }
            }
            else {
                toastr.error('Você deve inserir um nome de usuário!', 'Fique atento!');
            }
        }
    });

    $(document).ready(function () {
        $.backstretch("https://i2.wp.com/personalmarketingdigital.com.br/wp-content/uploads/2018/05/background-whatsapp-7.jpg?ssl=1")
        getUsers(userList);
    });
</script>